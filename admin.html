<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Trị - Hệ Thống Check-in</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .navbar { background-color: #0d6efd; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .navbar .navbar-brand, .navbar .nav-link { color: #fff !important; font-weight: 500; }
        .admin-stat-card { background: linear-gradient(135deg, #0d6efd, #764ba2); color: white; border-radius: 12px; padding: 20px; }
        .admin-stat-card h1 { font-size: 2.5rem; font-weight: 700; }
        #admin .list-container { background-color: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); overflow: hidden; }
        #admin .list-header { background-color: #198754; color: white; padding: 1rem 1.5rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; }
        #admin .table thead th { font-weight: 600; }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        .action-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            min-width: 90px;
        }

        @media (max-width: 767px) { .admin-stat-card h1 { font-size: 2rem; } }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-calendar-check"></i> Hội thảo 2024</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="index.html"><i class="fas fa-home"></i> Trang Chủ</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification Container (Toast) -->
    <div id="notification-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1150"></div>

    <div class="container mt-4" id="admin">
        <!-- Trang Admin -->
        <div id="admin-login" class="row justify-content-center align-items-center" style="min-height: 70vh;">
            <div class="col-md-4">
                <div class="card p-4 text-center">
                    <h4 class="mb-3"><i class="fas fa-shield-alt me-2"></i>Quản Trị Viên</h4>
                    <input type="password" class="form-control mb-3" id="adminPassword" placeholder="Mật khẩu admin">
                    <button class="btn btn-primary w-100" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>Đăng Nhập
                    </button>
                </div>
            </div>
        </div>

        <div id="admin-panel" style="display: none;">
            <div class="row g-4 mb-4">
                <div class="col-12 col-md-6 col-xl-3"><div class="admin-stat-card text-center"><h1 id="totalRegistered">0</h1><p>Tổng đăng ký</p></div></div>
                <div class="col-12 col-md-6 col-xl-3"><div class="admin-stat-card text-center"><h1 id="totalCheckedIn">0</h1><p>Đã check-in</p></div></div>
                <div class="col-12 col-md-6 col-xl-3"><div class="admin-stat-card text-center"><h1 id="totalPending">0</h1><p>Chưa check-in</p></div></div>
                <div class="col-12 col-md-6 col-xl-3"><div class="admin-stat-card text-center"><h1 id="checkinRate">0%</h1><p>Tỷ lệ check-in</p></div></div>
            </div>
            <div class="list-container">
                <div class="list-header">
                    <h5><i class="fas fa-users me-2"></i>Danh sách người tham dự</h5>
                    <div>
                        <button class="btn btn-light btn-sm" onclick="loadAdminData()"><i class="fas fa-sync-alt me-2"></i>Tải lại</button>
                        <button class="btn btn-light btn-sm ms-2" onclick="exportToExcel()"><i class="fas fa-file-excel me-2"></i>Xuất Excel</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>STT</th><th>Họ tên</th><th>Email</th><th>Điện thoại</th><th>Công ty</th><th>Trạng thái</th><th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="participantsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Participant Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Chỉnh sửa thông tin</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-id">
                        <div class="mb-3"><label for="edit-name" class="form-label">Họ và tên</label><input type="text" class="form-control" id="edit-name" required></div>
                        <div class="mb-3"><label for="edit-email" class="form-label">Email</label><input type="email" class="form-control" id="edit-email"></div>
                        <div class="mb-3"><label for="edit-phone" class="form-label">Số điện thoại</label><input type="tel" class="form-control" id="edit-phone" required></div>
                        <div class="mb-3"><label for="edit-company" class="form-label">Công ty/Tổ chức</label><input type="text" class="form-control" id="edit-company"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-primary" onclick="saveChanges()">Lưu thay đổi</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://daavpmtwlarsmwyhjxeg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhYXZwbXR3bGFyc213eWhqeGVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMzE4ODIsImV4cCI6MjA2NDYwNzg4Mn0.mGu2KMRzAOg2L7h4AU8eFaZlzJLD57W5vsGd_eGDeFk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let editModal = null;

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            container.appendChild(toast);
            setTimeout(() => {
                const bsToast = new bootstrap.Toast(toast, { autohide: true });
                bsToast.hide();
                setTimeout(() => toast.remove(), 5000);
            }, 5000);
        }

        // --- ADMIN FLOW ---
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (btoa(password) === 'YWRtaW4xMjM=') {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadAdminData();
            } else {
                showNotification('Mật khẩu không đúng!', 'warning');
            }
        }

        async function loadAdminData() {
            try {
                const { data: participants, error } = await supabase.from('attendees').select('*').order('registered_at', { ascending: false });
                if (error) throw error;
                
                const total = participants.length;
                const checkedIn = participants.filter(p => p.checked_in).length;
                document.getElementById('totalRegistered').textContent = total;
                document.getElementById('totalCheckedIn').textContent = checkedIn;
                document.getElementById('totalPending').textContent = total - checkedIn;
                document.getElementById('checkinRate').textContent = `${total > 0 ? ((checkedIn / total) * 100).toFixed(0) : 0}%`;

                const tbody = document.getElementById('participantsList');
                tbody.innerHTML = '';
                participants.forEach((p, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${p.name}</td>
                        <td>${p.email || 'N/A'}</td>
                        <td>${p.phone}</td>
                        <td>${p.company || 'N/A'}</td>
                        <td>${p.checked_in ? `<span class="badge bg-success">Đã Check-in</span>` : `<span class="badge bg-secondary">Chưa Check-in</span>`}</td>
                    `;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'action-cell';
                    
                    const editButton = document.createElement('button');
                    editButton.className = 'btn btn-action btn-outline-primary';
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.title = 'Sửa';
                    editButton.onclick = () => openEditModal(p);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-action btn-outline-danger';
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteButton.title = 'Xóa';
                    deleteButton.onclick = () => confirmDelete(p.id, p.name);

                    actionsCell.appendChild(editButton);
                    actionsCell.appendChild(deleteButton);
                });
            } catch (error) {
                showNotification(`Lỗi tải dữ liệu: ${error.message}`, 'danger');
            }
        }
        
        function openEditModal(participant) {
            document.getElementById('edit-id').value = participant.id;
            document.getElementById('edit-name').value = participant.name;
            document.getElementById('edit-email').value = participant.email || '';
            document.getElementById('edit-phone').value = participant.phone;
            document.getElementById('edit-company').value = participant.company || '';
            editModal.show();
        }

        async function saveChanges() {
            const id = document.getElementById('edit-id').value;
            const updatedData = { name: document.getElementById('edit-name').value, email: document.getElementById('edit-email').value, phone: document.getElementById('edit-phone').value, company: document.getElementById('edit-company').value };
            const { error } = await supabase.from('attendees').update(updatedData).eq('id', id);
            if (error) {
                showNotification(`Lỗi khi cập nhật: ${error.message}`, 'danger');
            } else {
                showNotification('Cập nhật thành công!', 'success');
                editModal.hide();
                loadAdminData();
            }
        }

        async function confirmDelete(id, name) {
            if (confirm(`Bạn có chắc chắn muốn xóa người tham dự "${name}" không?`)) {
                const { error } = await supabase.from('attendees').delete().eq('id', id);
                if (error) {
                    showNotification(`Lỗi khi xóa: ${error.message}`, 'danger');
                } else {
                    showNotification(`Đã xóa "${name}".`, 'success');
                    loadAdminData();
                }
            }
        }

        // === MODIFIED FUNCTION - START ===
        async function exportToExcel() {
            showNotification('Đang chuẩn bị file export...', 'info');
            
            // Lấy toàn bộ dữ liệu từ Supabase
            const { data: participants, error } = await supabase.from('attendees').select('*');
            if (error) {
                return showNotification(`Lỗi export: ${error.message}`, 'danger');
            }

            // Sắp xếp lại danh sách participants trong JavaScript
            // Người đã check-in sẽ được đưa lên đầu
            participants.sort((a, b) => {
                // Nếu trạng thái check-in khác nhau, ưu tiên người đã check-in (true đứng trước)
                if (a.checked_in !== b.checked_in) {
                    return a.checked_in ? -1 : 1;
                }
                
                // Nếu cả hai cùng trạng thái là Đã Check-in, sắp xếp theo thời gian check-in gần nhất
                if (a.checked_in) { 
                    return new Date(b.checkin_time) - new Date(a.checkin_time);
                }

                // Nếu cả hai cùng trạng thái là Chưa Check-in, sắp xếp theo thời gian đăng ký gần nhất
                return new Date(b.registered_at) - new Date(a.registered_at);
            });
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += ["STT", "Họ tên", "Email", "Điện thoại", "Công ty", "Trạng thái", "Thời gian Check-in"].join(',') + '\r\n';
            
            // Tạo nội dung CSV từ danh sách đã được sắp xếp
            participants.forEach((p, index) => {
                const row = [
                    index + 1,
                    `"${p.name.replace(/"/g, '""')}"`,
                    p.email || 'N/A',
                    `="${p.phone}"`,
                    `"${(p.company || 'N/A').replace(/"/g, '""')}"`,
                    p.checked_in ? "Đã Check-in" : "Chưa Check-in",
                    p.checkin_time ? new Date(p.checkin_time).toLocaleString('vi-VN') : "N/A"
                ];
                csvContent += row.join(',') + '\r\n';
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "danh_sach_tham_du.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // === MODIFIED FUNCTION - END ===


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
        });
    </script>
</body>
</html>